//
// usage: root -l 
// .L make3D.C
// the e.g.
// TFile *file = new TFile("Sum_Cd110_116403_116415.root", "READ")
// TH1I *hid = (TH1I*)file->Get("ID");
// TH3I *a = make3D(hid);
// a->Draw("BOX2");
//
TH3I *make3D(TH1I *hid) {
const  int nbins=15;  
const float_t r=100.;
const  int max_cr=162;
int id, max_counts=0,min_counts;

float_t t,p,x,y,z;

/*
float_t theta[max_cr],phi[max_cr];
TString angle_file_name;
angle_file_name = Form("crystal_angles.dat");

ifstream angle_file;
angle_file.open(angle_file_name);

        if ( angle_file.is_open() ) { 
			while ( angle_file ) {
				angle_file >> id >> t >> p;
				theta[id] = t;
				phi[id]   = p;
			}
		}
		else {
			cout << " no file open !!" << endl; 
		}
*/

float_t theta[max_cr]={90. , 99.6795 , 105.786 , 90 , 74.2137 , 80.3205 , 90. , 108.001 , 117.284 , 120.001 , 106.458 , 90 , 73.5423 , 59.9987 , 62.716 , 71.9993 , 97.41 , 115.379 , 125.971 , 131.842 , 133.908 , 119.471 , 106.458 , 90 , 73.5423 , 60.529 , 46.0923 , 48.1581 , 54.0294 , 64.6209 , 82.59 , 89.9979 , 105.097 , 121.719 , 134.479 , 144.002 , 149.499 , 148.287 , 133.907 , 120.003 , 105.786 , 90 , 74.2137 , 60.0005 , 46.0934 , 31.7134 , 30.501 , 35.9954 , 45.5211 , 58.281 , 74.9026 , 97.4085 , 115.378 , 134.478 , 150.535 , 161.868 , 164.908 , 149.496 , 131.839 , 117.284 , 99.6795 , 80.3205 , 62.716 , 48.1612 , 30.5037 , 15.0917 , 18.1315 , 29.4654 , 45.5223 , 64.6224 , 82.5915 , 90 , 107.998 , 125.968 , 143.998 , 161.864 , 180 , 161.864 , 144.002 , 125.968 , 108.002 , 90 , 72.0019 , 54.0322 , 36.0019 , 18.1361 , 0 , 18.1361 , 35.9981 , 54.0322 , 71.9981 , 99.6795 , 117.284 , 131.839 , 149.496 , 164.908 , 161.868 , 150.535 , 134.478 , 115.378 , 97.4085 , 82.5915 , 64.6224 , 45.5223 , 29.4654 , 18.1315 , 15.0918 , 30.5037 , 48.1612 , 62.716 , 80.3205 , 90 , 105.786 , 120 , 133.907 , 148.287 , 149.499 , 144.005 , 134.479 , 121.719 , 105.097 , 90.0021 , 74.9026 , 58.281 , 45.5211 , 35.9976 , 30.501 , 31.7134 , 46.0935 , 59.9966 , 74.2137 , 90 , 106.458 , 119.471 , 133.908 , 131.842 , 125.971 , 115.379 , 97.41 , 82.59 , 64.6209 , 54.0294 , 48.1581 , 46.0923 , 60.529 , 73.5423 , 90 , 106.458 , 120.001 , 117.284 , 108.001 , 90 , 71.9993 , 62.716 , 59.9987 , 73.5423 , 90 , 105.786 , 99.6795 , 80.3205 , 74.2137 , 90.};
float_t phi[max_cr]={0. , 346.422 , 5.27057 , 16.6216 , 5.27057 , 346.422 , 331.184 , 333.434 , 350.352 , 10.8129 , 23.9913 , 31.7189 , 23.9913 , 10.8129 , 350.352 , 333.434 , 318.313 , 319.236 , 336.211 , 353.747 , 18.2257 , 31.7205 , 39.4487 , 46.8184 , 39.4487 , 31.7205 , 18.2257 , 353.747 , 336.211 , 319.236 , 318.313 , 301.713 , 301.713 , 301.712 , 315.341 , 333.428 , 359.312 , 31.7231 , 45.2171 , 52.6262 , 58.1694 , 63.44 , 58.1694 , 52.6279 , 45.2171 , 31.7231 , 359.312 , 333.434 , 315.341 , 301.712 , 301.713 , 285.113 , 284.188 , 288.081 , 301.709 , 326.181 , 31.7284 , 64.1331 , 69.6945 , 73.0877 , 77.0176 , 77.0176 , 73.0877 , 69.6945 , 64.1331 , 31.7284 , 326.181 , 301.709 , 288.081 , 284.188 , 285.113 , 272.256 , 270 , 267.213 , 270 , 277.264 , 0 , 97.2639 , 90 , 87.2127 , 90 , 92.2556 , 90 , 87.2126 , 90 , 97.2639 , 0 , 277.264 , 270 , 267.213 , 270 , 257.018 , 253.088 , 249.694 , 244.133 , 211.728 , 146.181 , 121.709 , 108.081 , 104.188 , 105.113 , 105.113 , 104.188 , 108.081 , 121.709 , 146.181 , 211.728 , 244.133 , 249.694 , 253.088 , 257.018 , 243.44 , 238.169 , 232.628 , 225.217 , 211.723 , 179.312 , 153.434 , 135.341 , 121.712 , 121.713 , 121.713 , 121.713 , 121.712 , 135.341 , 153.428 , 179.312 , 211.723 , 225.217 , 232.626 , 238.169 , 226.818 , 219.449 , 211.72 , 198.226 , 173.747 , 156.211 , 139.236 , 138.313 , 138.313 , 139.236 , 156.211 , 173.747 , 198.226 , 211.72 , 219.449 , 211.719 , 203.991 , 190.813 , 170.352 , 153.434 , 151.184 , 153.434 , 170.352 , 190.813 , 203.991 , 196.622 , 185.271 , 166.422 , 166.422 , 185.271 , 180.};

TH3I* hmap = new TH3I("ID3","ID3",nbins,-r,r,nbins,-r,r,nbins,-r,r);
min_counts=hid->GetMaximum();


for (id=0;id<max_cr;id++) {
	int counts=hid->GetBinContent(id);
	if (counts>max_counts) max_counts=counts;
	if (counts>0 && counts<min_counts) min_counts=counts;
  }
for (id=0;id<max_cr;id++) {
	int counts=hid->GetBinContent(id);
	t=TMath::DegToRad()*theta[id];
	p=TMath::DegToRad()*phi[id];
	x = (float) 0.9*r*TMath::Sin(t)*TMath::Cos(p);
	y = (float) 0.9*r*TMath::Sin(t)*TMath::Sin(p);
	z = (float) 0.9*r*TMath::Cos(t);
//	cout << id << "  " << x << "  "  << y << "  "  << z << "  "  << counts << "  " << endl;
	if (counts>0) hmap->Fill(z,x,y,counts-min_counts);  // careful, we changed x,y,z for easier plotting
  }

hmap->GetYaxis()->SetTitle("Left (-) -> Right (+)");
hmap->GetZaxis()->SetTitle("Down (-) -> Up (+)");
hmap->GetXaxis()->SetTitle("Beam dump (-) -> Neutron source (+)");


  return hmap;
}
